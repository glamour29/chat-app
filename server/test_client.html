<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Chat 1-1 (Final)</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; background: #f9f9f9; }
        .msg-item { margin-bottom: 5px; padding: 5px; border-radius: 5px; }
        .my-msg { text-align: right; background-color: #dcf8c6; margin-left: 50px; }
        .other-msg { text-align: left; background-color: #fff; border: 1px solid #ddd; margin-right: 50px; }
    </style>
</head>
<body>
    <h2>üí¨ Test Chat Realtime + Database</h2>
    
    <div>
        <label>Room ID (Th·∫≠t): </label>
        <input type="text" id="roomId" value="6967b3ce5046a04b65faa081" style="width: 300px;">
        <button onclick="joinRoom()">1. V√†o ph√≤ng</button>
    </div>
    <hr>

    <div id="messages"></div>

    <input type="text" id="msgInput" placeholder="Nh·∫≠p tin nh·∫Øn..." style="width: 60%;">
    <button onclick="sendMessage()">2. G·ª≠i tin</button>

    <script>
        // Token c·ªßa User AN
        const MY_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2OTY2MzIxZmRjZTM2Mzg0ZjI4YWVlODUiLCJpYXQiOjE3NjgzMDUyNDIsImV4cCI6MTc3MDg5NzI0Mn0.kbOm-QoRK1zg1ky8eYgMna0P7Vo0j7C-nxSoEd98gnw"; 

        const socket = io("http://localhost:3000", {
            auth: { token: MY_TOKEN }
        });

        let currentRoom = "";

        socket.on("connect", () => {
            console.log("‚úÖ K·∫øt n·ªëi Socket th√†nh c√¥ng!");
            addLog("System", "ƒê√£ k·∫øt n·ªëi t·ªõi Server", "system");
        });

        // H√†m tham gia ph√≤ng
        function joinRoom() {
            const roomId = document.getElementById("roomId").value;
            currentRoom = roomId;
            socket.emit("join_room", roomId);
            addLog("System", "ƒêang v√†o ph√≤ng: " + roomId, "system");
        }

        socket.on("joined_room", (roomId) => {
            addLog("System", `‚úÖ ƒê√£ v√†o ph√≤ng ${roomId} th√†nh c√¥ng!`, "system");
        });

        // Nghe s·ª± ki·ªán nh·∫≠n tin nh·∫Øn t·ª´ ng∆∞·ªùi kh√°c
        socket.on("receive_message", (data) => {
            console.log("Tin m·ªõi nh·∫≠n:", data);
            
            // So s√°nh ID ng∆∞·ªùi g·ª≠i v·ªõi ID c·ªßa m√¨nh (ƒë·ªÉ chia tr√°i/ph·∫£i)
            // L∆∞u √Ω: data.senderId l√† ID t·ª´ DB, c√≤n socket.id l√† ID k·∫øt n·ªëi (kh√°c nhau).
            // ·ªû ƒë√¢y m√¨nh t·∫°m hi·ªÉn th·ªã ID ng∆∞·ªùi g·ª≠i ra ƒë·ªÉ check.
            const isMe = data.senderId === "6966321fdce36384f28aee85"; // ID c·ªßa An
            
            const senderName = isMe ? "T√¥i" : "Ng∆∞·ªùi kh√°c";
            const className = isMe ? "my-msg" : "other-msg";

            addMsgToScreen(senderName, data.content, className);
        });

        // H√†m g·ª≠i tin
        function sendMessage() {
            const content = document.getElementById("msgInput").value;
            if (!currentRoom) {
                alert("‚ùó Vui l√≤ng b·∫•m 'V√†o ph√≤ng' tr∆∞·ªõc!");
                return;
            }
            
            // G·ª≠i l√™n server
            socket.emit("send_message", {
                roomId: currentRoom,
                content: content
            });

            document.getElementById("msgInput").value = "";
        }

        // H√†m hi·ªÉn th·ªã log l√™n m√†n h√¨nh
        function addLog(sender, msg) {
            const div = document.createElement("div");
            div.innerHTML = `<i>${sender}: ${msg}</i>`;
            document.getElementById("messages").appendChild(div);
        }

        function addMsgToScreen(sender, msg, className) {
            const div = document.createElement("div");
            div.className = `msg-item ${className}`;
            div.innerHTML = `<b>${sender}:</b> ${msg}`;
            document.getElementById("messages").appendChild(div);
            // T·ª± ƒë·ªông cu·ªôn xu·ªëng d∆∞·ªõi c√πng
            const container = document.getElementById("messages");
            container.scrollTop = container.scrollHeight;
        }

        socket.on("connect_error", (err) => alert("L·ªói k·∫øt n·ªëi: " + err.message));
        socket.on("error", (msg) => alert("L·ªói Server: " + msg));
    </script>
</body>
</html>